<!DOCTYPE html>
<head>

</head>

<body>

    <script src="../lib/helpers.js"></script>

    <!-- PayPal Script -->
    <script src="https://www.paypalobjects.com/api/checkout.js" data-version-4></script>

    <script>
        // Exercise Setup
        function onCancel() {
            showDom('paypal-cancel');
        }

        function onError(err) {
            document.getElementById('error-message').textContent = err.message;
            showDom('paypal-error');
        }
        // END Setup

        // Create a function to call the SetExpressCheckout API 
            // Use PayPal library to call the Setexpress checkout API endpoint GET /paypal/classic/setexpresscheckout
                // In the then callback return the TOKEN property of the response
            // Return the response from the function call
        function setExpressCheckout() {
            return paypal
                    .request
                    .get('/paypal/classic/setexpresscheckout')
                    .then(function (data) {
                        return data.TOKEN;
                    });
        }

        // Create a function to call the getExpressCheckout API
            // Take a look at the data object for the token.
            // Use PayPal library to call getexpresscheckout api endpoint GET /paypal/classic/getexpresscheckout/YOURTOKEN
                // Then put the response in paypal-details DOM
                // Populate teh form values
                // You should be able to get most of this form a previous exercise.
        function getExpressCheckout(data, actions) {
            return paypal
                    .request
                    .get('/paypal/classic/getexpresscheckout/' + data.paymentToken)
                    .then(function (response) {
                        document.getElementById('paypal-details').textContent = JSON.stringify(response, null, 2);
                        document.getElementById('firstName').value = response.FIRSTNAME;
                        document.getElementById('lastName').value = response.LASTNAME;
                        document.getElementById('street').value = response.SHIPTOSTREET;
                        showDom('paypal-confirmation');
                    });
        }

        // Create a function to call the doExpressCheckout API
            // Use paypal library to call doexpresscheckout api endpoint POST /paypal/classic/doexpresscheckout
                // Populate the nvpParams variable with the correct values
                // Send the nvpParams variable with the api call.
            // Then output the response in the paypal-execute-details DOM id and show the paypal-end dom id.
        function doExpressCheckout(data, actions) {
            var nvpParams = {
                TOKEN: 'YOURTOKEN',
                PAYERID: 'YOURPAYERID',
                PAYMENTACTION: 'YOURPAYMENTACTION'
            };
            
            nvpParams.TOKEN = data.paymentToken;
            nvpParams.PAYERID = data.payerID;
            nvpParams.PAYMENTACTION = data.intent;

            return paypal
                    .request
                    .post('/paypal/classic/doexpresscheckout', nvpParams)
                    .then(function (result) {
                        document.getElementById('paypal-execute-details').textContent = JSON.stringify(result, null, 2);
                        showDom('paypal-end');
                    });
        }

        // Create a function executeSetup.
            // Use paypal library to cerate and return a new promise.
            // Create click event listener and attach it to the submitButton DOM id
                // Remember to prevent default.
                // Execute doExpressCheckout functoin
            // resolve the promise immediatley after setting the on click event

        function executeSetup(data, actions) {
            return new paypal.Promise(function (resolve, reject) {
                document
                    .getElementById('submitButton')
                    .addEventListener('click', function (event) {
                        event.preventDefault();
                        return doExpressCheckout(data, actions);
                    });
                resolve();
            });
        }
        
        // Create an onAutorize Callback function
            // Use paypal.Promise.all to execute the getExpressCheckout and executeSetup functions simultaneously
            // Pro Tip: the one argument to all function is an array of promises
            // return the result of the all function
        function onAuthorize(data, actions) {
            return paypal
                    .Promise
                    .all([getExpressCheckout(data, actions), executeSetup(data, actions)]);
        }
    

        // Call the correct functions in the correct event callbacks
        paypal.Button.render({
            env: 'sandbox',
            payment: setExpressCheckout,
            onAuthorize: onAuthorize,
            onCancel: onCancel,
            onError: onError,
            style: {
                size: 'medium',
                color: 'yellow',
                shape: 'rect'
            }
        }, '#paypal-button');

    </script>
    <div id="paypal-error" style="display:none">
        <h2>Whoopsie Daisy</h2>
        <div>We seem to have a problem here</div>
        <pre id="error-message"></pre>
    </div>
    <div id="paypal-cancel" style="display:none">
        <h2>We are severly disappointed</h2>
        <div>You shuold definitely click the paypal button again</div>
    </div>
    <div id="paypal-button"></div>
    <pre id="paypal-details" style="display:none"></pre>
    <div id="paypal-confirmation" style="display:none">
        <h2>Confirmation</h2>
        <form id="confirmationForm">
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" class="form-control" id="firstName" placeholder="First Name" name="firstName" disabled>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" class="form-control" id="lastName" placeholder="Last Name" name="lastName" disabled>
            </div>
            <div class="form-group">
                <label for="street">Street</label>
                <input type="text" class="form-control" id="street" placeholder="Street" name="street" disabled>
            </div>
            
            <button id="submitButton" type="submit" class="btn btn-default">Place Order</button>
        </form>
    </div>
    <div id="paypal-end" style="display:none">
        <h2>Yay your payment is complete</h2>
        <pre id="paypal-execute-details"></pre>
    </div>
    </div>
    <a href="index.html">Go Back</a>
</body>
</html>